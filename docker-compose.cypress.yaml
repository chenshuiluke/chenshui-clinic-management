version: '3.8'

services:
  # PostgreSQL Database for Cypress tests
  db:
    image: postgres:16-alpine
    container_name: clinic-db-cypress
    environment:
      POSTGRES_USER: clinic_user
      POSTGRES_PASSWORD: clinic_password
      POSTGRES_DB: clinic_db
      # Use tmpfs for in-memory storage
      PGDATA: /dev/shm/pgdata
    tmpfs:
      - /dev/shm:size=512m
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U clinic_user -d clinic_db"]
      interval: 5s
      timeout: 3s
      retries: 5
    shm_size: 256m

  # Backend API server for Cypress to interact with
  backend-api:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: clinic-backend-cypress
    environment:
      - PORT=3000
      - NODE_ENV=test
      - CYPRESS_ENV=true
      - DB_HOST=db
      - DB_PORT=5432
      - DB_NAME=clinic_db
      - DB_USER=clinic_user
      - DB_PASSWORD=clinic_password
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=local
      - AWS_SECRET_ACCESS_KEY=local
      - SQS_ENDPOINT=http://sqs:9324
      - JWT_SECRET=test-secret-key-for-cypress
      - JWT_REFRESH_SECRET=test-refresh-secret-key-for-cypress
    volumes:
      - ./backend/src:/app/src
      - ./backend/package.json:/app/package.json
      - ./backend/package-lock.json:/app/package-lock.json
      - ./backend/tsconfig.json:/app/tsconfig.json:ro
      - backend_cypress_node_modules:/app/node_modules
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3000/healthz || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 30s
    command: sh -c "npm i && npm run start"
    ports:
      - "3000:3000"

  # Frontend dev server for Cypress to test against
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: clinic-frontend-cypress
    environment:
      - VITE_API_BASE_URL=http://host.docker.internal:3000
      - NODE_ENV=test
    volumes:
      - ./frontend/src:/app/src:ro
      - ./frontend/index.html:/app/index.html
      - ./frontend/tsconfig.json:/app/tsconfig.json:ro
      - ./frontend/tsconfig.app.json:/app/tsconfig.app.json:ro
      - ./frontend/tsconfig.node.json:/app/tsconfig.node.json:ro
      - ./frontend/vite.config.ts:/app/vite.config.ts:ro
      - ./frontend/cypress.config.ts:/app/cypress.config.ts:ro
      - frontend_cypress_node_modules:/app/node_modules
    depends_on:
      backend-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:5173/admin/login || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 45s
    command: sh -c "npm i && npm run build && npm run preview -- --host 0.0.0.0 --port 5173 "
    ports:
      - "5173:5173"

  # Cypress test runner
  cypress:
    image: cypress/included:13.17.0
    container_name: clinic-cypress-runner
    env_file:
      - ./frontend/.env
    environment:
      - CYPRESS_BASE_URL=http://frontend:5173
      - CYPRESS_API_URL=http://backend-api:3000
      - CYPRESS_video=true
      - CYPRESS_screenshotOnRunFailure=true
      - CYPRESS_defaultCommandTimeout=10000
      - CYPRESS_grepFilterSpecs=true
      - CYPRESS_grep=${CYPRESS_grep:-}
      - CYPRESS_grepTags=${CYPRESS_grepTags:-@focus}
      - NODE_ENV=test
    volumes:
      - ./frontend/cypress:/e2e/cypress:ro
      - ./frontend/cypress.docker.config.cjs:/e2e/cypress.config.cjs:ro
      - ./frontend/cypress/videos:/e2e/cypress/videos:rw
      - ./frontend/cypress/screenshots:/e2e/cypress/screenshots:rw
      - ./frontend/package.json:/e2e/package.json:rw
      - ./frontend/package-lock.json:/e2e/package-lock.json:rw
      - ./frontend/tsconfig.json:/e2e/tsconfig.json:ro
      - cypress_node_modules:/e2e/node_modules
    depends_on:
      frontend:
        condition: service_healthy
      backend-api:
        condition: service_healthy
    working_dir: /e2e
    entrypoint: ["/bin/bash", "-c"]
    command: ["npm install && cypress run --config-file /e2e/cypress.config.cjs --record --key $$CYPRESS_RECORD_KEY"]
    ipc: host
    shm_size: 2gb

volumes:
  backend_cypress_node_modules:
  frontend_cypress_node_modules:
  cypress_node_modules: